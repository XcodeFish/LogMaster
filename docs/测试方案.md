# LogMaster æµ‹è¯•æ–¹æ¡ˆ

æœ¬æ–‡æ¡£æè¿°äº† LogMaster é¡¹ç›®çš„å®Œæ•´æµ‹è¯•æ–¹æ¡ˆï¼ŒåŒ…æ‹¬å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€ç«¯åˆ°ç«¯æµ‹è¯•å’Œæ€§èƒ½æµ‹è¯•ç­‰å†…å®¹ï¼Œéµå¾ªç°ä»£JavaScriptåº“çš„æµ‹è¯•æœ€ä½³å®è·µã€‚

## ç›®å½•

1. [æµ‹è¯•æ¶æ„æ¦‚è¿°](#ä¸€æµ‹è¯•æ¶æ„æ¦‚è¿°)
2. [å•å…ƒæµ‹è¯•](#äºŒå•å…ƒæµ‹è¯•)
3. [é›†æˆæµ‹è¯•](#ä¸‰é›†æˆæµ‹è¯•)
4. [æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•](#å››æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•)
5. [æ€§èƒ½æµ‹è¯•](#äº”æ€§èƒ½æµ‹è¯•)
6. [è¦†ç›–ç‡è¦æ±‚ä¸åˆ†æ](#å…­è¦†ç›–ç‡è¦æ±‚ä¸åˆ†æ)
7. [æŒç»­é›†æˆæµ‹è¯•æµç¨‹](#ä¸ƒæŒç»­é›†æˆæµ‹è¯•æµç¨‹)
8. [æµ‹è¯•æœ€ä½³å®è·µ](#å…«æµ‹è¯•æœ€ä½³å®è·µ)

## ä¸€ã€æµ‹è¯•æ¶æ„æ¦‚è¿°

### 1. æµ‹è¯•æŠ€æœ¯æ ˆ

LogMaster é¡¹ç›®é‡‡ç”¨ä»¥ä¸‹æµ‹è¯•æŠ€æœ¯æ ˆï¼š

```mermaid
graph TD
    A[Jest] --> B[å•å…ƒæµ‹è¯•æ¡†æ¶]
    C[Testing Library] --> D[DOMæµ‹è¯•]
    E[Playwright] --> F[æµè§ˆå™¨è‡ªåŠ¨åŒ–æµ‹è¯•]
    G[Istanbul/nyc] --> H[ä»£ç è¦†ç›–ç‡]
    I[Benchmark.js] --> J[æ€§èƒ½æµ‹è¯•]
```

| æŠ€æœ¯           | ç”¨é€”                   | ä¼˜åŠ¿                                     |
|--------------|----------------------|------------------------------------------|
| Jest         | å•å…ƒæµ‹è¯•/é›†æˆæµ‹è¯•        | å†…ç½®æ–­è¨€ã€æ¨¡æ‹Ÿã€è¦†ç›–ç‡æŠ¥å‘Šï¼Œé›¶é…ç½®          |
| Testing Library | UIç»„ä»¶æµ‹è¯•           | ä¸“æ³¨äºç”¨æˆ·è¡Œä¸ºæµ‹è¯•ï¼Œæ¨¡æ‹Ÿå®é™…ä½¿ç”¨åœºæ™¯       |
| Playwright   | E2Eæµè§ˆå™¨æµ‹è¯•          | æ”¯æŒå¤šæµè§ˆå™¨ï¼Œå¼ºå¤§çš„è‡ªåŠ¨åŒ–èƒ½åŠ›            |
| Istanbul/nyc | ä»£ç è¦†ç›–ç‡å·¥å…·          | è¯¦ç»†çš„è¦†ç›–ç‡æŠ¥å‘Šå’Œåˆ†æ                  |
| Benchmark.js | æ€§èƒ½æµ‹è¯•               | ç²¾ç¡®çš„åŸºå‡†æ€§èƒ½æµ‹è¯•                      |

### 2. æµ‹è¯•åˆ†å±‚ç­–ç•¥

LogMaster é‡‡ç”¨åˆ†å±‚æµ‹è¯•ç­–ç•¥ï¼Œç¡®ä¿ä¸åŒå±‚æ¬¡çš„ä»£ç è´¨é‡ï¼š

```mermaid
graph TD
    A["å•å…ƒæµ‹è¯• (70%)"] --> E[æµ‹è¯•è¦†ç›–ç­–ç•¥]
    B["é›†æˆæµ‹è¯• (20%)"] --> E
    C["E2Eæµ‹è¯• (5%)"] --> E
    D["æ€§èƒ½æµ‹è¯• (5%)"] --> E
```

- **å•å…ƒæµ‹è¯•**ï¼šè¦†ç›–æ‰€æœ‰æ ¸å¿ƒå‡½æ•°/æ–¹æ³•
- **é›†æˆæµ‹è¯•**ï¼šéªŒè¯ä¸»è¦æ¨¡å—é—´åä½œ
- **E2Eæµ‹è¯•**ï¼šç¡®ä¿æ•´ä½“åŠŸèƒ½åœ¨å„ç§ç¯å¢ƒä¸‹æ­£å¸¸å·¥ä½œ
- **æ€§èƒ½æµ‹è¯•**ï¼šç¡®ä¿æ—¥å¿—è¾“å‡ºä¸å½±å“åº”ç”¨æ€§èƒ½

### 3. æµ‹è¯•ç›®å½•ç»“æ„

```
tests/
â”œâ”€â”€ unit/                        # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ core/                    # æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ constants.spec.js    # å¸¸é‡å®šä¹‰æµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ formatter.spec.js    # æ ¼å¼åŒ–åŠŸèƒ½æµ‹è¯•
â”‚   â”‚   â””â”€â”€ utils.spec.js        # å·¥å…·å‡½æ•°æµ‹è¯•
â”‚   â”œâ”€â”€ LogMaster.spec.js        # LogMasterä¸»ç±»æµ‹è¯•
â”‚   â””â”€â”€ transports/              # ä¼ è¾“æ¨¡å—æµ‹è¯•
â”‚       â”œâ”€â”€ base.spec.js
â”‚       â”œâ”€â”€ file.spec.js
â”‚       â””â”€â”€ http.spec.js
â”œâ”€â”€ integration/                 # é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ logger-transports.spec.js
â”œâ”€â”€ e2e/                         # ç«¯åˆ°ç«¯æµ‹è¯•
â”‚   â”œâ”€â”€ browser.test.js          # æµè§ˆå™¨ç¯å¢ƒæµ‹è¯•
â”‚   â””â”€â”€ node.test.js             # Nodeç¯å¢ƒæµ‹è¯•
â”œâ”€â”€ performance/                 # æ€§èƒ½æµ‹è¯•
â”‚   â””â”€â”€ logging-benchmarks.js
â””â”€â”€ fixtures/                    # æµ‹è¯•æ•°æ®
```

### 4. æµ‹è¯•ç­–ç•¥æ¦‚è§ˆ

| æµ‹è¯•ç±»å‹ | é¢‘ç‡   | CI è§¦å‘ç‚¹           | æ‰§è¡Œç¯å¢ƒ       | ç›®æ ‡è¦†ç›–ç‡ |
|---------|--------|-------------------|--------------|---------|
| å•å…ƒæµ‹è¯• | æ¯æ¬¡æäº¤ | PR, Push to main  | Node.js     | >90%    |
| é›†æˆæµ‹è¯• | æ¯æ¬¡æäº¤ | PR, Push to main  | Node.js     | >80%    |
| E2Eæµ‹è¯• | æ¯æ—¥    | Scheduled, Release | çœŸå®æµè§ˆå™¨ç¯å¢ƒ | å…³é”®è·¯å¾„ |
| æ€§èƒ½æµ‹è¯• | æ¯å‘¨    | Scheduled, Release | æ ‡å‡†åŸºå‡†ç¯å¢ƒ  | N/A     |

## äºŒã€å•å…ƒæµ‹è¯•

### 1. æµ‹è¯•æ¡†æ¶ï¼šJest

é€‰æ‹© Jest ä½œä¸ºä¸»è¦æµ‹è¯•æ¡†æ¶çš„åŸå› ï¼š

- é›¶é…ç½®å¯åŠ¨ï¼Œå†…ç½®æ–­è¨€åº“å’Œæ¨¡æ‹ŸåŠŸèƒ½
- å¿«é€Ÿå¹¶è¡Œæµ‹è¯•æ‰§è¡Œ
- å†…ç½®ä»£ç è¦†ç›–ç‡æŠ¥å‘Š
- å¿«ç…§æµ‹è¯•èƒ½åŠ›
- æ´»è·ƒçš„ç¤¾åŒºæ”¯æŒ

### 2. Jest é…ç½®

```javascript
// jest.config.js
module.exports = {
  // æŒ‡å®šæµ‹è¯•æ–‡ä»¶åŒ¹é…æ¨¡å¼
  testMatch: [
    '**/tests/unit/**/*.spec.js',
    '**/tests/integration/**/*.spec.js'
  ],

  // å¿½ç•¥çš„ç›®å½•
  testPathIgnorePatterns: ['/node_modules/', '/dist/'],

  // æµ‹è¯•ç¯å¢ƒ
  testEnvironment: 'jsdom',

  // æ¯ä¸ªæµ‹è¯•å‰è‡ªåŠ¨æ¸…é™¤æ¨¡æ‹Ÿå’Œå®ä¾‹
  clearMocks: true,

  // ä»£ç è¦†ç›–ç‡è®¾ç½®
  collectCoverage: true,
  coverageDirectory: 'coverage',
  collectCoverageFrom: [
    'src/**/*.js',
    '!src/**/*.d.ts',
    '!**/node_modules/**'
  ],
  coverageThreshold: {
    global: {
      branches: 90,
      functions: 90,
      lines: 90,
      statements: 90
    }
  },

  // æŠ¥å‘Šæ ¼å¼
  coverageReporters: ['text', 'lcov', 'html'],

  // è®¾ç½®æ¨¡å—åˆ«å
  moduleNameMapper: {
    '^@/(.*)$': '<rootDir>/src/$1'
  },

  // å˜æ¢å™¨é…ç½®
  transform: {
    '^.+\\.js$': 'babel-jest'
  }
};
```

### 3. æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•

#### 3.1 LogMaster ä¸»ç±»æµ‹è¯•

```javascript
// tests/unit/LogMaster.spec.js
import LogMaster from '../../src/LogMaster';

describe('LogMaster æ ¸å¿ƒåŠŸèƒ½', () => {
  // åœ¨æ¯ä¸ªæµ‹è¯•å‰é‡ç½®æ§åˆ¶å°æ–¹æ³•
  let consoleLogSpy;
  let consoleInfoSpy;
  let consoleWarnSpy;
  let consoleErrorSpy;

  beforeEach(() => {
    // ç›‘è§†æ§åˆ¶å°æ–¹æ³•
    consoleLogSpy = jest.spyOn(console, 'log').mockImplementation();
    consoleInfoSpy = jest.spyOn(console, 'info').mockImplementation();
    consoleWarnSpy = jest.spyOn(console, 'warn').mockImplementation();
    consoleErrorSpy = jest.spyOn(console, 'error').mockImplementation();
  });

  afterEach(() => {
    // æ¢å¤æ‰€æœ‰æ¨¡æ‹Ÿ
    jest.restoreAllMocks();
  });

  test('åº”è¯¥èƒ½å¤Ÿè®¾ç½®ç¯å¢ƒ', () => {
    LogMaster.setEnvironment('production');
    expect(LogMaster._environment).toBe('production');
  });

  test('è®¾ç½®æ— æ•ˆç¯å¢ƒåº”ä¿æŒé»˜è®¤ç¯å¢ƒ', () => {
    LogMaster.setEnvironment('development'); // é¦–å…ˆè®¾ç½®ä¸ºå·²çŸ¥çŠ¶æ€
    LogMaster.setEnvironment('invalid');
    expect(LogMaster._environment).toBe('development');
    expect(consoleWarnSpy).toHaveBeenCalled();
  });

  test('åº”è¯¥æ ¹æ®ç¯å¢ƒè‡ªåŠ¨è®¾ç½®æ—¥å¿—çº§åˆ«', () => {
    LogMaster.setEnvironment('development');
    expect(LogMaster._logLevel).toBe(0); // DEBUGçº§åˆ«

    LogMaster.setEnvironment('testing');
    expect(LogMaster._logLevel).toBe(1); // INFOçº§åˆ«

    LogMaster.setEnvironment('production');
    expect(LogMaster._logLevel).toBe(3); // ERRORçº§åˆ«
  });

  test('åº”è¯¥èƒ½å¤Ÿæ‰‹åŠ¨è®¾ç½®æ—¥å¿—çº§åˆ«', () => {
    LogMaster.setLogLevel('WARN');
    expect(LogMaster._logLevel).toBe(2); // WARNçº§åˆ«
  });

  test('è®¾ç½®æ— æ•ˆæ—¥å¿—çº§åˆ«åº”ä¿æŒå½“å‰çº§åˆ«', () => {
    LogMaster.setLogLevel('DEBUG'); // é¦–å…ˆè®¾ç½®ä¸ºå·²çŸ¥çŠ¶æ€
    LogMaster.setLogLevel('INVALID');
    expect(LogMaster._logLevel).toBe(0); // ä¿æŒDEBUGçº§åˆ«
    expect(consoleWarnSpy).toHaveBeenCalled();
  });

  test('åº”èƒ½è‡ªå®šä¹‰ä¸»é¢˜', () => {
    const customTheme = {
      debug: '#ff0000',
      timestamp: '#00ff00'
    };

    LogMaster.setTheme(customTheme);
    expect(LogMaster._theme.debug).toBe('#ff0000');
    expect(LogMaster._theme.timestamp).toBe('#00ff00');
    // æœªè®¾ç½®çš„å±æ€§åº”ä¿æŒé»˜è®¤å€¼
    expect(LogMaster._theme.info).toBe(LogMaster._theme.info);
  });

  test('DEBUGçº§åˆ«æ—¥å¿—åº”è°ƒç”¨console.log', () => {
    LogMaster.setLogLevel('DEBUG');
    LogMaster.debug('æµ‹è¯•æ¶ˆæ¯');
    expect(consoleLogSpy).toHaveBeenCalled();
  });

  test('INFOçº§åˆ«æ—¥å¿—åº”è°ƒç”¨console.info', () => {
    LogMaster.setLogLevel('INFO');
    LogMaster.info('æµ‹è¯•æ¶ˆæ¯');
    expect(consoleInfoSpy).toHaveBeenCalled();
  });

  test('WARNçº§åˆ«æ—¥å¿—åº”è°ƒç”¨console.warn', () => {
    LogMaster.setLogLevel('WARN');
    LogMaster.warn('æµ‹è¯•æ¶ˆæ¯');
    expect(consoleWarnSpy).toHaveBeenCalled();
  });

  test('ERRORçº§åˆ«æ—¥å¿—åº”è°ƒç”¨console.error', () => {
    LogMaster.setLogLevel('ERROR');
    LogMaster.error('æµ‹è¯•æ¶ˆæ¯');
    expect(consoleErrorSpy).toHaveBeenCalled();
  });

  test('æ—¥å¿—çº§åˆ«è¿‡æ»¤åº”æ­£å¸¸å·¥ä½œ', () => {
    LogMaster.setLogLevel('WARN'); // è®¾ç½®ä¸ºWARNçº§åˆ«

    LogMaster.debug('è°ƒè¯•æ¶ˆæ¯');
    LogMaster.info('ä¿¡æ¯æ¶ˆæ¯');
    LogMaster.warn('è­¦å‘Šæ¶ˆæ¯');
    LogMaster.error('é”™è¯¯æ¶ˆæ¯');

    // DEBUGå’ŒINFOåº”è¢«è¿‡æ»¤æ‰
    expect(consoleLogSpy).not.toHaveBeenCalled();
    expect(consoleInfoSpy).not.toHaveBeenCalled();

    // WARNå’ŒERRORåº”æ­£å¸¸è¾“å‡º
    expect(consoleWarnSpy).toHaveBeenCalled();
    expect(consoleErrorSpy).toHaveBeenCalled();
  });

  test('prodErroråº”åœ¨ä»»ä½•çº§åˆ«éƒ½è¾“å‡º', () => {
    LogMaster.setLogLevel('SILENT'); // è®¾ç½®ä¸ºé™é»˜çº§åˆ«
    LogMaster.prodError('ä¸¥é‡é”™è¯¯');
    expect(consoleErrorSpy).toHaveBeenCalled();
  });

  test('groupæ–¹æ³•åº”åœ¨éç”Ÿäº§ç¯å¢ƒæ­£å¸¸å·¥ä½œ', () => {
    const groupSpy = jest.spyOn(console, 'group').mockImplementation();
    const groupEndSpy = jest.spyOn(console, 'groupEnd').mockImplementation();
    const callback = jest.fn();

    LogMaster.setEnvironment('development');
    LogMaster.group('æµ‹è¯•åˆ†ç»„', callback);

    expect(groupSpy).toHaveBeenCalled();
    expect(callback).toHaveBeenCalled();
    expect(groupEndSpy).toHaveBeenCalled();
  });

  test('groupæ–¹æ³•åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¸è°ƒç”¨æ§åˆ¶å°åˆ†ç»„', () => {
    const groupSpy = jest.spyOn(console, 'group').mockImplementation();
    const callback = jest.fn();

    LogMaster.setEnvironment('production');
    LogMaster.group('æµ‹è¯•åˆ†ç»„', callback);

    expect(callback).toHaveBeenCalled(); // å›è°ƒå‡½æ•°åº”è¢«æ‰§è¡Œ
    expect(groupSpy).not.toHaveBeenCalled(); // ä¸åº”è°ƒç”¨console.group
  });

  test('tableæ–¹æ³•åº”è¢«æ­£ç¡®è°ƒç”¨', () => {
    const tableSpy = jest.spyOn(console, 'table').mockImplementation();
    const testData = [{ id: 1, name: 'test' }];

    LogMaster.setEnvironment('development');
    LogMaster.setLogLevel('INFO');
    LogMaster.table(testData, ['id', 'name']);

    expect(tableSpy).toHaveBeenCalledWith(testData, ['id', 'name']);
  });

  test('ç”Ÿäº§ç¯å¢ƒä¸­tableæ–¹æ³•ä¸åº”è¢«è°ƒç”¨', () => {
    const tableSpy = jest.spyOn(console, 'table').mockImplementation();
    const testData = [{ id: 1, name: 'test' }];

    LogMaster.setEnvironment('production');
    LogMaster.table(testData);

    expect(tableSpy).not.toHaveBeenCalled();
  });
});
```

### 4. å·¥å…·ç±»æµ‹è¯•

```javascript
// tests/unit/core/utils.spec.js
import { formatError, isObject, truncateString } from '../../../src/core/utils';

describe('å·¥å…·å‡½æ•°æµ‹è¯•', () => {
  test('formatError åº”å¤„ç† Error å¯¹è±¡', () => {
    const error = new Error('æµ‹è¯•é”™è¯¯');
    const result = formatError(error);
    expect(result).toContain('æµ‹è¯•é”™è¯¯');
    expect(result).toContain('stack');
  });

  test('formatError åº”å¤„ç†å­—ç¬¦ä¸²', () => {
    const result = formatError('æµ‹è¯•é”™è¯¯');
    expect(result).toBe('æµ‹è¯•é”™è¯¯');
  });

  test('formatError åº”å¤„ç†å…¶ä»–ç±»å‹', () => {
    const obj = { message: 'æµ‹è¯•' };
    const result = formatError(obj);
    expect(result).toContain(JSON.stringify(obj, null, 2));
  });

  test('isObject åº”æ­£ç¡®è¯†åˆ«å¯¹è±¡', () => {
    expect(isObject({})).toBe(true);
    expect(isObject([])).toBe(true); // æ•°ç»„ä¹Ÿæ˜¯å¯¹è±¡
    expect(isObject(null)).toBe(false);
    expect(isObject(undefined)).toBe(false);
    expect(isObject('å­—ç¬¦ä¸²')).toBe(false);
    expect(isObject(123)).toBe(false);
  });

  test('truncateString åº”æ­£ç¡®æˆªæ–­å­—ç¬¦ä¸²', () => {
    const longStr = 'è¿™æ˜¯ä¸€ä¸ªå¾ˆé•¿å¾ˆé•¿çš„å­—ç¬¦ä¸²ç”¨äºæµ‹è¯•æˆªæ–­åŠŸèƒ½';
    expect(truncateString(longStr, 10)).toBe('è¿™æ˜¯ä¸€ä¸ªå¾ˆé•¿...');
    expect(truncateString(longStr, 100)).toBe(longStr); // ä¸éœ€è¦æˆªæ–­
    expect(truncateString(null, 10)).toBe('null'); // å¤„ç†null
  });
});
```

### 5. æµ‹è¯•æ¨¡æ‹Ÿç­–ç•¥

#### 5.1 æ§åˆ¶å°æ–¹æ³•æ¨¡æ‹Ÿ

```javascript
beforeEach(() => {
  // åˆ›å»ºæ§åˆ¶å°æ–¹æ³•çš„å¤‡ä»½
  global.originalConsole = {
    log: console.log,
    info: console.info,
    warn: console.warn,
    error: console.error,
    group: console.group,
    groupEnd: console.groupEnd,
    table: console.table
  };

  // æ›¿æ¢ä¸ºæ¨¡æ‹Ÿå‡½æ•°
  console.log = jest.fn();
  console.info = jest.fn();
  console.warn = jest.fn();
  console.error = jest.fn();
  console.group = jest.fn();
  console.groupEnd = jest.fn();
  console.table = jest.fn();
});

afterEach(() => {
  // æ¢å¤æ§åˆ¶å°æ–¹æ³•
  console.log = global.originalConsole.log;
  console.info = global.originalConsole.info;
  console.warn = global.originalConsole.warn;
  console.error = global.originalConsole.error;
  console.group = global.originalConsole.group;
  console.groupEnd = global.originalConsole.groupEnd;
  console.table = global.originalConsole.table;
});
```

#### 5.2 è¿è¡Œç¯å¢ƒæ¨¡æ‹Ÿ

```javascript
// æ¨¡æ‹Ÿæµè§ˆå™¨ç¯å¢ƒ
beforeEach(() => {
  // æ¨¡æ‹Ÿ performance API
  global.performance = {
    now: jest.fn(() => 1000)
  };

  // æ¨¡æ‹Ÿ localStorage
  global.localStorage = {
    getItem: jest.fn(),
    setItem: jest.fn()
  };
});
```

### 6. å¿«ç…§æµ‹è¯•

å¯¹äºæ—¥å¿—æ ¼å¼åŒ–è¾“å‡ºï¼Œä½¿ç”¨å¿«ç…§æµ‹è¯•ç¡®ä¿è¾“å‡ºæ ¼å¼ä¸€è‡´æ€§ï¼š

```javascript
test('ç¾åŒ–æ—¥å¿—æ ¼å¼åº”ä¿æŒä¸€è‡´', () => {
  const consoleSpy = jest.spyOn(console, 'info').mockImplementation();

  // å›ºå®šçš„æ—¶é—´æˆ³ç”¨äºæµ‹è¯•
  jest.spyOn(Date.prototype, 'toLocaleTimeString').mockReturnValue('12:00:00');

  LogMaster.info('æµ‹è¯•æ¶ˆæ¯', { data: 'value' });

  // æ£€æŸ¥è°ƒç”¨å‚æ•°
  const args = consoleSpy.mock.calls[0];
  expect(args).toMatchSnapshot();
});
```

## ä¸‰ã€é›†æˆæµ‹è¯•

### 1. é›†æˆæµ‹è¯•ç­–ç•¥

é›†æˆæµ‹è¯•çš„ä¸»è¦ç›®çš„æ˜¯éªŒè¯ä¸åŒæ¨¡å—ä¹‹é—´çš„åä½œæ˜¯å¦æ­£å¸¸ï¼Œç‰¹åˆ«æ˜¯é’ˆå¯¹ä»¥ä¸‹æ–¹é¢ï¼š

- LogMaster æ ¸å¿ƒä¸ä¼ è¾“ç³»ç»Ÿçš„äº¤äº’
- å¤šç§ä¼ è¾“æ–¹å¼çš„ç»„åˆä½¿ç”¨
- åœ¨ä¸åŒç¯å¢ƒï¼ˆæµè§ˆå™¨/Node.jsï¼‰ä¸‹çš„è¡Œä¸ºä¸€è‡´æ€§

### 2. æµ‹è¯•åœºæ™¯

#### 2.1 ä¼ è¾“ç³»ç»Ÿé›†æˆæµ‹è¯•

```javascript
// tests/integration/logger-transports.spec.js
import LogMaster from '../../src/LogMaster';
import { FileTransport, HttpTransport } from '../../src/transports';

describe('æ—¥å¿—ä¼ è¾“é›†æˆæµ‹è¯•', () => {
  // å…ˆå¤‡ä»½åŸå§‹ç¯å¢ƒ
  const originalEnv = process.env.NODE_ENV;
  let logMasterInstance;
  let mockFileTransport;
  let mockHttpTransport;

  beforeEach(() => {
    // åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„LogMasterå®ä¾‹
    logMasterInstance = new LogMaster();

    // åˆ›å»ºæ¨¡æ‹Ÿçš„ä¼ è¾“å®ä¾‹
    mockFileTransport = new FileTransport({
      filename: 'test.log'
    });
    mockFileTransport.log = jest.fn();

    mockHttpTransport = new HttpTransport({
      url: 'https://example.com/logs'
    });
    mockHttpTransport.log = jest.fn();

    // ç›‘è§†æ§åˆ¶å°
    jest.spyOn(console, 'log').mockImplementation();
    jest.spyOn(console, 'info').mockImplementation();
    jest.spyOn(console, 'warn').mockImplementation();
    jest.spyOn(console, 'error').mockImplementation();
  });

  afterEach(() => {
    // æ¸…ç†æµ‹è¯•ç¯å¢ƒ
    jest.restoreAllMocks();
    // æ¢å¤åŸå§‹ç¯å¢ƒ
    process.env.NODE_ENV = originalEnv;
  });

  test('æ·»åŠ å¤šä¸ªä¼ è¾“å®ä¾‹ååº”æ­£ç¡®è°ƒç”¨æ‰€æœ‰ä¼ è¾“', () => {
    logMasterInstance.addTransport(mockFileTransport);
    logMasterInstance.addTransport(mockHttpTransport);

    logMasterInstance.error('æµ‹è¯•é”™è¯¯æ¶ˆæ¯');

    // éªŒè¯æ‰€æœ‰ä¼ è¾“éƒ½è¢«è°ƒç”¨
    expect(mockFileTransport.log).toHaveBeenCalled();
    expect(mockHttpTransport.log).toHaveBeenCalled();

    // éªŒè¯è°ƒç”¨å‚æ•°
    const fileCallArgs = mockFileTransport.log.mock.calls[0];
    const httpCallArgs = mockHttpTransport.log.mock.calls[0];

    expect(fileCallArgs[0]).toBe('ERROR');
    expect(fileCallArgs[1]).toContain('æµ‹è¯•é”™è¯¯æ¶ˆæ¯');
    expect(httpCallArgs[0]).toBe('ERROR');
    expect(httpCallArgs[1]).toContain('æµ‹è¯•é”™è¯¯æ¶ˆæ¯');
  });

  test('ä¸åŒæ—¥å¿—çº§åˆ«åº”æ­£ç¡®è¿‡æ»¤ä¼ è¾“', () => {
    // åˆ›å»ºä¸€ä¸ªä»…æ¥æ”¶ERRORæ—¥å¿—çš„ä¼ è¾“
    mockFileTransport.options = { minLevel: 'ERROR' };
    logMasterInstance.addTransport(mockFileTransport);

    // åˆ›å»ºä¸€ä¸ªæ¥æ”¶INFOåŠä»¥ä¸Šæ—¥å¿—çš„ä¼ è¾“
    mockHttpTransport.options = { minLevel: 'INFO' };
    logMasterInstance.addTransport(mockHttpTransport);

    // æµ‹è¯•ä¸åŒçº§åˆ«çš„æ—¥å¿—
    logMasterInstance.debug('è°ƒè¯•ä¿¡æ¯');
    logMasterInstance.info('æ™®é€šä¿¡æ¯');
    logMasterInstance.error('é”™è¯¯ä¿¡æ¯');

    // éªŒè¯æ ¹æ®çº§åˆ«è¿‡æ»¤
    expect(mockFileTransport.log.mock.calls.length).toBe(1); // åªæ”¶åˆ°ERROR
    expect(mockHttpTransport.log.mock.calls.length).toBe(2); // æ”¶åˆ°INFOå’ŒERROR
  });

  test('é“¾å¼APIè°ƒç”¨åº”æ­£å¸¸å·¥ä½œ', () => {
    // æµ‹è¯•é“¾å¼API
    const result = logMasterInstance
      .setEnvironment('development')
      .setLogLevel('DEBUG')
      .addTransport(mockFileTransport)
      .addTransport(mockHttpTransport);

    // é“¾å¼è°ƒç”¨åº”è¿”å›å®ä¾‹æœ¬èº«
    expect(result).toBe(logMasterInstance);

    // è®¾ç½®åº”ç”Ÿæ•ˆ
    expect(logMasterInstance._environment).toBe('development');
    expect(logMasterInstance._logLevel).toBe(0); // DEBUG
  });

  test('ä¼ è¾“ç³»ç»Ÿåœ¨ç”Ÿäº§ç¯å¢ƒä¸­åº”æ­£å¸¸å·¥ä½œ', () => {
    // è®¾ç½®ç”Ÿäº§ç¯å¢ƒ
    logMasterInstance.setEnvironment('production');
    logMasterInstance.addTransport(mockFileTransport);

    // åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒDEBUGæ—¥å¿—ä¸åº”è¾“å‡º
    logMasterInstance.debug('è°ƒè¯•ä¿¡æ¯');
    expect(mockFileTransport.log).not.toHaveBeenCalled();

    // ERRORæ—¥å¿—åº”æ­£å¸¸è¾“å‡º
    logMasterInstance.error('é”™è¯¯ä¿¡æ¯');
    expect(mockFileTransport.log).toHaveBeenCalled();
  });
});
```

#### 2.2 å¼‚æ­¥ä¼ è¾“æµ‹è¯•

```javascript
// tests/integration/async-transport.spec.js
import LogMaster from '../../src/LogMaster';
import { AsyncTransport } from '../../src/transports';

describe('å¼‚æ­¥ä¼ è¾“é›†æˆæµ‹è¯•', () => {
  let logMaster;
  let mockAsyncTransport;

  beforeEach(() => {
    logMaster = new LogMaster();

    // åˆ›å»ºæ¨¡æ‹Ÿå¼‚æ­¥ä¼ è¾“
    mockAsyncTransport = new AsyncTransport({
      async process(logs) {
        return Promise.resolve(true);
      }
    });

    // ç›‘è§†å¼‚æ­¥å¤„ç†æ–¹æ³•
    jest.spyOn(mockAsyncTransport, 'process');

    logMaster.addTransport(mockAsyncTransport);
  });

  test('å¼‚æ­¥ä¼ è¾“åº”æ­£ç¡®æ‰¹å¤„ç†æ—¥å¿—', async () => {
    // å‘é€å¤šæ¡æ—¥å¿—
    logMaster.info('æ¶ˆæ¯1');
    logMaster.info('æ¶ˆæ¯2');
    logMaster.info('æ¶ˆæ¯3');

    // åˆ·æ–°ç¼“å†²åŒºï¼Œè§¦å‘å¼‚æ­¥å¤„ç†
    await mockAsyncTransport.flush();

    // éªŒè¯æ‰¹å¤„ç†è¢«è°ƒç”¨ï¼ŒåŒ…å«æ‰€æœ‰æ¶ˆæ¯
    expect(mockAsyncTransport.process).toHaveBeenCalledTimes(1);
    const batchArg = mockAsyncTransport.process.mock.calls[0][0];
    expect(batchArg.length).toBe(3);
  });

  test('é”™è¯¯ä¼ è¾“åº”æ­£ç¡®é‡è¯•', async () => {
    // æ¨¡æ‹Ÿä¼ è¾“å¤±è´¥
    let attemptCount = 0;
    mockAsyncTransport.process = jest.fn().mockImplementation(() => {
      attemptCount++;
      if (attemptCount === 1) {
        return Promise.reject(new Error('ä¼ è¾“å¤±è´¥'));
      }
      return Promise.resolve(true);
    });

    // è®¾ç½®é‡è¯•é€‰é¡¹
    mockAsyncTransport.retryOptions = {
      attempts: 3,
      delay: 100
    };

    // å‘é€æ—¥å¿—
    logMaster.error('é‡è¦é”™è¯¯');

    // åˆ·æ–°å¹¶ç­‰å¾…é‡è¯•å®Œæˆ
    await mockAsyncTransport.flush();

    // éªŒè¯é‡è¯•æœºåˆ¶
    expect(attemptCount).toBe(2); // ç¬¬ä¸€æ¬¡å¤±è´¥ï¼Œç¬¬äºŒæ¬¡æˆåŠŸ
    expect(mockAsyncTransport.process).toHaveBeenCalledTimes(2);
  });
});
```

### 3. ç¯å¢ƒäº¤äº’æµ‹è¯•

```javascript
// tests/integration/environment.spec.js
import LogMaster from '../../src/LogMaster';

describe('ç¯å¢ƒæ„ŸçŸ¥é›†æˆæµ‹è¯•', () => {
  // ä¿å­˜åŸå§‹ç¯å¢ƒå˜é‡
  const originalNodeEnv = process.env.NODE_ENV;

  // åœ¨æ¯ä¸ªæµ‹è¯•åæ¢å¤ç¯å¢ƒ
  afterEach(() => {
    process.env.NODE_ENV = originalNodeEnv;
    jest.restoreAllMocks();
  });

  test('åº”æ ¹æ®NODE_ENVè‡ªåŠ¨è®¾ç½®ç¯å¢ƒ', () => {
    // æ¨¡æ‹Ÿä¸åŒçš„NODE_ENV
    process.env.NODE_ENV = 'production';

    // åˆ›å»ºæ–°å®ä¾‹ï¼Œåº”è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒ
    const logger = new LogMaster();

    // éªŒè¯æ˜¯å¦æ­£ç¡®è®¾ç½®äº†ç”Ÿäº§ç¯å¢ƒ
    expect(logger._environment).toBe('production');
    expect(logger._logLevel).toBe(3); // ERRORçº§åˆ«
  });

  test('åº”èƒ½æ£€æµ‹æµè§ˆå™¨ç¯å¢ƒ', () => {
    // æ¨¡æ‹Ÿæµè§ˆå™¨ç¯å¢ƒ
    global.window = {};
    global.navigator = { userAgent: 'test' };

    // åˆ›å»ºæ–°å®ä¾‹
    const logger = new LogMaster();

    // éªŒè¯æ˜¯å¦æ­£ç¡®æ£€æµ‹åˆ°æµè§ˆå™¨ç¯å¢ƒ
    expect(logger._isBrowser).toBe(true);

    // æ¸…ç†
    delete global.window;
    delete global.navigator;
  });

  test('æœ¬åœ°å­˜å‚¨ç¯å¢ƒé…ç½®åº”æ­£å¸¸å·¥ä½œ', () => {
    // æ¨¡æ‹Ÿæµè§ˆå™¨ç¯å¢ƒå’ŒlocalStorage
    global.window = {};
    global.localStorage = {
      getItem: jest.fn().mockReturnValue('{"logLevel":"WARN","theme":"dark"}'),
      setItem: jest.fn()
    };

    // åˆ›å»ºæ”¯æŒæœ¬åœ°å­˜å‚¨çš„å®ä¾‹
    const logger = new LogMaster({ persistConfig: true });

    // éªŒè¯æ˜¯å¦ä»æœ¬åœ°å­˜å‚¨åŠ è½½äº†é…ç½®
    expect(logger._logLevel).toBe(2); // WARNçº§åˆ«
    expect(logger._theme.name).toBe('dark');

    // ä¿®æ”¹é…ç½®
    logger.setLogLevel('ERROR');

    // éªŒè¯æ˜¯å¦ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    expect(global.localStorage.setItem).toHaveBeenCalled();

    // æ¸…ç†
    delete global.window;
    delete global.localStorage;
  });
});
```

### 4. ä¼ è¾“ç»„åˆæµ‹è¯•

ç¡®ä¿å¤šä¸ªä¼ è¾“æ–¹å¼ç»„åˆä½¿ç”¨æ—¶ä¸ä¼šç›¸äº’å¹²æ‰°ï¼š

```javascript
// tests/integration/transport-combination.spec.js
import LogMaster from '../../src/LogMaster';
import { FileTransport, ConsoleTransport, HttpTransport } from '../../src/transports';

describe('ä¼ è¾“ç»„åˆæµ‹è¯•', () => {
  let logger;
  let mockFile;
  let mockConsole;
  let mockHttp;

  beforeEach(() => {
    logger = new LogMaster();

    // è®¾ç½®æ¨¡æ‹Ÿä¼ è¾“
    mockFile = {
      log: jest.fn()
    };

    mockConsole = {
      log: jest.fn()
    };

    mockHttp = {
      log: jest.fn()
    };

    // æ·»åŠ å¤šç§ä¼ è¾“
    logger.addTransport(mockFile);
    logger.addTransport(mockConsole);
    logger.addTransport(mockHttp);
  });

  test('ç§»é™¤å•ä¸ªä¼ è¾“ä¸åº”å½±å“å…¶ä»–ä¼ è¾“', () => {
    // ç§»é™¤æ§åˆ¶å°ä¼ è¾“
    logger.removeTransport(mockConsole);

    // è¾“å‡ºæ—¥å¿—
    logger.info('æµ‹è¯•æ¶ˆæ¯');

    // éªŒè¯å…¶ä»–ä¼ è¾“ä»æ­£å¸¸å·¥ä½œ
    expect(mockFile.log).toHaveBeenCalled();
    expect(mockConsole.log).not.toHaveBeenCalled();
    expect(mockHttp.log).toHaveBeenCalled();
  });

  test('ä¼ è¾“é”™è¯¯ä¸åº”å½±å“å…¶ä»–ä¼ è¾“', () => {
    // è®¾ç½®ä¸€ä¸ªä¼šæŠ›å‡ºé”™è¯¯çš„ä¼ è¾“
    mockConsole.log = jest.fn(() => {
      throw new Error('ä¼ è¾“å¤±è´¥');
    });

    // è®¾ç½®é”™è¯¯å¤„ç†å™¨
    const errorHandler = jest.fn();
    logger.setTransportErrorHandler(errorHandler);

    // è¾“å‡ºæ—¥å¿—
    logger.info('æµ‹è¯•æ¶ˆæ¯');

    // éªŒè¯é”™è¯¯è¢«æ•è·ä½†å…¶ä»–ä¼ è¾“æ­£å¸¸
    expect(errorHandler).toHaveBeenCalled();
    expect(mockFile.log).toHaveBeenCalled();
    expect(mockConsole.log).toHaveBeenCalled();
    expect(mockHttp.log).toHaveBeenCalled();
  });

  test('ä¼ è¾“é…ç½®åº”ç‹¬ç«‹ç”Ÿæ•ˆ', () => {
    // è®¾ç½®ä¸åŒä¼ è¾“çš„è¿‡æ»¤çº§åˆ«
    mockFile.options = { minLevel: 'ERROR' };
    mockConsole.options = { minLevel: 'INFO' };
    mockHttp.options = { minLevel: 'WARN' };

    // å‘é€ä¸åŒçº§åˆ«æ—¥å¿—
    logger.debug('è°ƒè¯•');    // æ‰€æœ‰ä¼ è¾“éƒ½åº”å¿½ç•¥
    logger.info('ä¿¡æ¯');     // ä»…æ§åˆ¶å°æ˜¾ç¤º
    logger.warn('è­¦å‘Š');     // æ§åˆ¶å°å’ŒHTTPä¼ è¾“
    logger.error('é”™è¯¯');    // æ‰€æœ‰ä¼ è¾“éƒ½åº”æ˜¾ç¤º

    // éªŒè¯è°ƒç”¨æ¬¡æ•°
    expect(mockFile.log).toHaveBeenCalledTimes(1);     // åªæ¥æ”¶ERROR
    expect(mockConsole.log).toHaveBeenCalledTimes(3);  // æ¥æ”¶INFOã€WARNã€ERROR
    expect(mockHttp.log).toHaveBeenCalledTimes(2);     // æ¥æ”¶WARNã€ERROR
  });
});
```

## å››ã€æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•

### 1. æµ‹è¯•ç­–ç•¥

æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•çš„ç›®æ ‡æ˜¯ç¡®ä¿ LogMaster åœ¨å„ç§ç›®æ ‡æµè§ˆå™¨ç¯å¢ƒä¸­æ­£å¸¸å·¥ä½œã€‚é‡‡ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š

1. **çœŸå®æµè§ˆå™¨æµ‹è¯•**ï¼šä½¿ç”¨ Playwright åœ¨å¤šä¸ªçœŸå®æµè§ˆå™¨ä¸­è¿è¡Œæµ‹è¯•
2. **ç‰¹æ€§æ£€æµ‹æµ‹è¯•**ï¼šéªŒè¯ç‰¹æ€§æ£€æµ‹å’Œé™çº§æœºåˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œ
3. **è§†è§‰å›å½’æµ‹è¯•**ï¼šç¡®ä¿æ—¥å¿—æ ¼å¼åœ¨ä¸åŒæµè§ˆå™¨ä¸­ä¿æŒä¸€è‡´

### 2. Playwright é…ç½®

```javascript
// playwright.config.js
const { devices } = require('@playwright/test');

module.exports = {
  testDir: './tests/e2e',
  timeout: 30000,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: [
    ['html'],
    ['json', { outputFile: 'test-results/e2e-results.json' }]
  ],

  use: {
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    {
      name: 'edge',
      use: { ...devices['Desktop Edge'] },
    },
    // ç§»åŠ¨æµè§ˆå™¨æµ‹è¯•
    {
      name: 'mobile-chrome',
      use: { ...devices['Pixel 5'] },
    },
    {
      name: 'mobile-safari',
      use: { ...devices['iPhone 12'] },
    }
  ],
};
```

### 3. æµè§ˆå™¨åŠŸèƒ½æµ‹è¯•

```javascript
// tests/e2e/browser.test.js
import { test, expect } from '@playwright/test';

test.describe('LogMaster æµè§ˆå™¨åŠŸèƒ½æµ‹è¯•', () => {
  // åœ¨æ¯ä¸ªæµ‹è¯•å‰åŠ è½½æµ‹è¯•é¡µé¢
  test.beforeEach(async ({ page }) => {
    // åŠ è½½æµ‹è¯•é¡µé¢
    await page.goto('http://localhost:8080/test-page.html');

    // ç­‰å¾… LogMaster åŠ è½½å®Œæˆ
    await page.waitForSelector('[data-testid="logger-ready"]');
  });

  test('åº”æ­£ç¡®æ˜¾ç¤ºå½©è‰²æ—¥å¿—', async ({ page }) => {
    // è§¦å‘å½©è‰²æ—¥å¿—è¾“å‡º
    await page.click('#trigger-color-log');

    // ä»é¡µé¢è·å–æ§åˆ¶å°è¾“å‡ºï¼ˆé€šè¿‡é¡µé¢ä¸­çš„console spyï¼‰
    const consoleOutput = await page.evaluate(() => {
      return window.capturedConsoleLogs;
    });

    // éªŒè¯æ˜¯å¦åŒ…å«æ ·å¼ä¿¡æ¯
    expect(consoleOutput.some(log => log.includes('color:'))).toBeTruthy();
  });

  test('åº”åœ¨ä¸æ”¯æŒæ ·å¼æ—¶é™çº§ä½¿ç”¨ç®€å•æ—¥å¿—', async ({ page }) => {
    // æ¨¡æ‹Ÿä¸æ”¯æŒæ ·å¼çš„æµè§ˆå™¨
    await page.evaluate(() => {
      window.originalConsoleLog = console.log;
      console.log = function() {
        // ç®€å•é‡å†™ï¼Œç§»é™¤æ ·å¼å‚æ•°
        const args = Array.from(arguments).filter(arg => typeof arg !== 'string' || !arg.includes('%c'));
        window.originalConsoleLog.apply(this, args);
      };
    });

    // è§¦å‘æ—¥å¿—è¾“å‡º
    await page.click('#trigger-basic-log');

    // éªŒè¯é™çº§ç‰ˆæ—¥å¿—
    const consoleOutput = await page.evaluate(() => window.capturedConsoleLogs);

    // åº”åŒ…å«å›¾æ ‡å’Œæ¶ˆæ¯ï¼Œä½†æ²¡æœ‰æ ·å¼
    expect(consoleOutput.some(log =>
      log.includes('â„¹ï¸') && !log.includes('%c')
    )).toBeTruthy();

    // æ¢å¤æ§åˆ¶å°
    await page.evaluate(() => {
      console.log = window.originalConsoleLog;
    });
  });

  test('åº”æ­£ç¡®å¤„ç†ä¸åŒç±»å‹çš„å¯¹è±¡', async ({ page }) => {
    // è§¦å‘è¾“å‡ºå¤æ‚å¯¹è±¡
    await page.click('#trigger-object-log');

    // è·å–å’Œæ£€æŸ¥è¾“å‡º
    const consoleOutput = await page.evaluate(() => window.capturedConsoleLogs);

    // éªŒè¯ä¸åŒç±»å‹çš„å¤„ç†
    expect(consoleOutput.some(log => log.includes('"nested"'))).toBeTruthy(); // å¯¹è±¡
    expect(consoleOutput.some(log => log.includes('[object Map]') ||
                                    log.includes('Map('))).toBeTruthy(); // Mapå¯¹è±¡
  });
});
```

### 4. å…¼å®¹æ€§çŸ©é˜µæµ‹è¯•

```javascript
// tests/e2e/compatibility-matrix.test.js
import { test, expect } from '@playwright/test';

// æµ‹è¯•çŸ©é˜µï¼Œå®šä¹‰ä¸åŒçš„æµè§ˆå™¨ç‰¹æ€§ç»„åˆ
const compatibilityMatrix = [
  { name: 'ç°ä»£æµè§ˆå™¨', features: ['colors', 'groups', 'table'] },
  { name: 'åŸºæœ¬æµè§ˆå™¨', features: ['colors'] },
  { name: 'æœ‰é™æµè§ˆå™¨', features: [] }
];

for (const profile of compatibilityMatrix) {
  test.describe(`å…¼å®¹æ€§: ${profile.name}`, () => {
    test.beforeEach(async ({ page }) => {
      // åŠ è½½æµ‹è¯•é¡µé¢
      await page.goto('http://localhost:8080/test-page.html');

      // é…ç½®æµè§ˆå™¨ç¯å¢ƒ
      await page.evaluate(features => {
        // æ¨¡æ‹Ÿæµè§ˆå™¨ç‰¹æ€§æ”¯æŒ
        window.browserFeatures = features;
      }, profile.features);

      // åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
      await page.click('#init-logger');
    });

    test('åº”é€‚åº”å½“å‰æµè§ˆå™¨èƒ½åŠ›', async ({ page }) => {
      // è§¦å‘åŠŸèƒ½æµ‹è¯•
      await page.click('#test-all-features');

      // æ£€æŸ¥æ—¥å¿—è¾“å‡ºç»“æœ
      const result = await page.evaluate(() => window.testResults);

      // éªŒè¯æ¯ä¸ªç‰¹æ€§æ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œ
      if (profile.features.includes('colors')) {
        expect(result.colorSupport).toBeTruthy();
      } else {
        expect(result.colorSupport).toBeFalsy();
      }

      if (profile.features.includes('groups')) {
        expect(result.groupSupport).toBeTruthy();
      } else {
        expect(result.groupSupport).toBeFalsy();
      }

      // å³ä½¿ä¸æ”¯æŒç‰¹å®šç‰¹æ€§ï¼ŒåŸºæœ¬æ—¥å¿—åŠŸèƒ½åº”æ­£å¸¸å·¥ä½œ
      expect(result.basicLogging).toBeTruthy();
    });
  });
}
```

### 5. è§†è§‰å›å½’æµ‹è¯•

```javascript
// tests/e2e/visual-regression.test.js
import { test, expect } from '@playwright/test';
import fs from 'fs';
import path from 'path';

test.describe('è§†è§‰å›å½’æµ‹è¯•', () => {
  test('æ—¥å¿—è¾“å‡ºæ ¼å¼åº”ä¿æŒä¸€è‡´', async ({ page }) => {
    // åŠ è½½æµ‹è¯•é¡µé¢
    await page.goto('http://localhost:8080/visual-test.html');

    // è§¦å‘æ ‡å‡†æ—¥å¿—ç»„
    await page.click('#trigger-standard-logs');

    // ç­‰å¾…æ—¥å¿—æ¸²æŸ“å®Œæˆ
    await page.waitForSelector('.log-complete');

    // æˆªå›¾æ§åˆ¶å°è¾“å‡ºåŒºåŸŸ
    const screenshot = await page.locator('.console-output').screenshot();

    // æ¯”è¾ƒæˆªå›¾ä¸åŸºå‡†å›¾
    const browserName = page.context().browser().name();
    const baselinePath = path.join(__dirname, `../baselines/${browserName}-console.png`);

    if (!fs.existsSync(baselinePath)) {
      // é¦–æ¬¡è¿è¡Œï¼Œä¿å­˜ä¸ºåŸºå‡†å›¾
      fs.writeFileSync(baselinePath, screenshot);
      console.log(`å·²åˆ›å»ºåŸºå‡†å›¾: ${baselinePath}`);
    } else {
      // æ¯”è¾ƒæˆªå›¾
      const baseline = fs.readFileSync(baselinePath);

      // ä½¿ç”¨å›¾åƒæ¯”è¾ƒç®—æ³•
      const { diffPixels, diffPercentage } = await compareImages(screenshot, baseline);

      // å…è®¸1%çš„å·®å¼‚ï¼ˆå­—ä½“æ¸²æŸ“ç­‰å¾®å°å·®å¼‚ï¼‰
      expect(diffPercentage).toBeLessThan(1);

      // ä¿å­˜å·®å¼‚å›¾ä»¥ä¾¿åˆ†æ
      if (diffPercentage > 0) {
        const diffPath = path.join(__dirname, `../results/${browserName}-diff.png`);
        fs.writeFileSync(diffPath, diffImage);
        console.log(`å·®å¼‚å›¾å·²ä¿å­˜: ${diffPath}`);
      }
    }
  });
});

// å›¾åƒæ¯”è¾ƒè¾…åŠ©å‡½æ•°
async function compareImages(img1, img2) {
  // è¿™é‡Œå¯ä»¥ä½¿ç”¨åƒç´ æ¯”è¾ƒåº“ï¼Œå¦‚pixelmatch
  // ç®€åŒ–å®ç°ï¼Œå®é™…é¡¹ç›®ä¸­å¯ä»¥ä½¿ç”¨ä¸“ä¸šåº“
  return { diffPixels: 0, diffPercentage: 0 };
}
```

## äº”ã€æ€§èƒ½æµ‹è¯•

### 1. æ€§èƒ½æµ‹è¯•ç›®æ ‡

æ€§èƒ½æµ‹è¯•çš„ä¸»è¦ç›®æ ‡æ˜¯ç¡®ä¿ LogMaster æ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š

- æ—¥å¿—è®°å½•æ“ä½œçš„ä½å»¶è¿Ÿï¼Œæœ€å°åŒ–å¯¹åº”ç”¨æ€§èƒ½çš„å½±å“
- é«˜æ•ˆçš„å†…å­˜ä½¿ç”¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
- åœ¨é«˜é¢‘æ—¥å¿—è®°å½•åœºæ™¯ä¸‹ä¿æŒç¨³å®šæ€§
- ç¡®ä¿ä¼ è¾“ç³»ç»Ÿä¸é˜»å¡ä¸»çº¿ç¨‹

### 2. æµ‹è¯•æŒ‡æ ‡

| æŒ‡æ ‡             | ç›®æ ‡å€¼           | è¡¡é‡æ–¹æ³•              |
|-----------------|----------------|----------------------|
| æ—¥å¿—è®°å½•å»¶è¿Ÿ      | <1ms            | å¾®åŸºå‡†æµ‹è¯•            |
| CPU å ç”¨ç‡       | <5%             | è´Ÿè½½æµ‹è¯•              |
| å†…å­˜å ç”¨         | <2MB            | å†…å­˜åˆ†æ              |
| æ‰¹é‡æ—¥å¿—ååé‡    | >1000æ¡/ç§’      | è´Ÿè½½æµ‹è¯•              |
| DOM æ¸²æŸ“å½±å“     | æ— æ˜æ˜¾å¸§ç‡ä¸‹é™    | è§†è§‰æ€§èƒ½æµ‹è¯•          |

### 3. åŸºå‡†æµ‹è¯•é…ç½®

```javascript
// tests/performance/logging-benchmarks.js
import Benchmark from 'benchmark';
import LogMaster from '../../src/LogMaster';

const suite = new Benchmark.Suite();

// æµ‹è¯•ç¯å¢ƒå‡†å¤‡
const setupTest = () => {
  // ç¦ç”¨å®é™…æ§åˆ¶å°è¾“å‡º
  jest.spyOn(console, 'log').mockImplementation();
  jest.spyOn(console, 'info').mockImplementation();
  jest.spyOn(console, 'warn').mockImplementation();
  jest.spyOn(console, 'error').mockImplementation();

  // åˆ›å»ºä¸€ä¸ªå¹²å‡€çš„æ—¥å¿—å®ä¾‹
  return new LogMaster();
};

// æµ‹è¯•ç¯å¢ƒæ¸…ç†
const teardownTest = () => {
  jest.restoreAllMocks();
};

// æ·»åŠ åŸºå‡†æµ‹è¯•
suite
  .add('å•æ¡å­—ç¬¦ä¸²æ—¥å¿—', () => {
    const logger = setupTest();
    logger.info('è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ—¥å¿—');
    teardownTest();
  })
  .add('å•æ¡å¸¦å¯¹è±¡æ—¥å¿—', () => {
    const logger = setupTest();
    logger.info('æµ‹è¯•å¯¹è±¡', { user: 'test', id: 123 });
    teardownTest();
  })
  .add('å¤šå‚æ•°æ—¥å¿—', () => {
    const logger = setupTest();
    logger.info('ç”¨æˆ·', 'test', 'å·²ç™»å½•', { time: Date.now() });
    teardownTest();
  })
  .add('ä¸åŒçº§åˆ«æ—¥å¿—', () => {
    const logger = setupTest();
    logger.debug('è°ƒè¯•ä¿¡æ¯');
    logger.info('ä¿¡æ¯');
    logger.warn('è­¦å‘Š');
    logger.error('é”™è¯¯');
    teardownTest();
  })
  .add('è¿‡æ»¤æ‰çš„æ—¥å¿—', () => {
    const logger = setupTest();
    logger.setLogLevel('ERROR');
    logger.debug('è¿™æ¡æ—¥å¿—ä¸ä¼šæ˜¾ç¤º');
    logger.info('è¿™æ¡æ—¥å¿—ä¹Ÿä¸ä¼šæ˜¾ç¤º');
    logger.warn('è¿™æ¡æ—¥å¿—è¿˜æ˜¯ä¸ä¼šæ˜¾ç¤º');
    logger.error('è¿™æ¡æ—¥å¿—ä¼šæ˜¾ç¤º');
    teardownTest();
  })
  .add('å¸¦æ ¼å¼åŒ–çš„é•¿å­—ç¬¦ä¸²', () => {
    const logger = setupTest();
    logger.info('è¿™æ˜¯ä¸€æ¡å¾ˆé•¿çš„æ—¥å¿—ä¿¡æ¯ï¼ŒåŒ…å«å¤§é‡çš„æ–‡æœ¬å†…å®¹ï¼Œæµ‹è¯•æ—¥å¿—æ ¼å¼åŒ–å¯¹æ€§èƒ½çš„å½±å“...'
      + 'é€šå¸¸åœ¨å®é™…åœºæ™¯ä¸­å¯èƒ½ä¼šæœ‰è¿™ç§è¯¦ç»†çš„ç³»ç»ŸçŠ¶æ€æè¿°æˆ–é”™è¯¯æŠ¥å‘Šä¿¡æ¯ï¼Œéœ€è¦ç¡®ä¿æ€§èƒ½è‰¯å¥½ã€‚'
      + 'é‡å¤çš„å†…å®¹å¢åŠ å­—ç¬¦ä¸²é•¿åº¦...');
    teardownTest();
  })

  // ç›‘å¬å®Œæˆäº‹ä»¶å¹¶è¾“å‡ºç»“æœ
  .on('cycle', (event) => {
    console.log(String(event.target));
  })
  .on('complete', function() {
    console.log('Fastest is ' + this.filter('fastest').map('name'));
  })

  // è¿è¡Œæµ‹è¯•
  .run({ 'async': true });
```

### 4. å†…å­˜ä½¿ç”¨æµ‹è¯•

```javascript
// tests/performance/memory-usage.js
import LogMaster from '../../src/LogMaster';
import { performance, PerformanceObserver } from 'perf_hooks';
import v8 from 'v8';

// é…ç½®æ€§èƒ½è§‚å¯Ÿè€…
const obs = new PerformanceObserver((items) => {
  console.log(items.getEntries()[0].name + ': ' + items.getEntries()[0].duration + 'ms');
});
obs.observe({ entryTypes: ['measure'] });

// åƒåœ¾å›æ”¶åŠ©æ‰‹
const forceGC = () => {
  if (global.gc) {
    global.gc();
  } else {
    console.warn('å¼ºåˆ¶GCä¸å¯ç”¨ - è¯·ä½¿ç”¨ --expose-gc è¿è¡ŒNode');
  }
};

// è®°å½•å †å†…å­˜ä½¿ç”¨
const getMemoryUsage = () => {
  return process.memoryUsage().heapUsed / 1024 / 1024;
};

// æ€§èƒ½æµ‹è¯•
const runMemoryTest = (logger, iterations) => {
  const initialMemory = getMemoryUsage();
  console.log(`åˆå§‹å†…å­˜ä½¿ç”¨: ${initialMemory.toFixed(2)} MB`);

  performance.mark('start');

  // æ¨¡æ‹Ÿé«˜é¢‘æ—¥å¿—è®°å½•
  for (let i = 0; i < iterations; i++) {
    logger.info(`æµ‹è¯•æ—¥å¿— #${i}`);
    if (i % 100 === 0) {
      logger.warn(`è­¦å‘Šæ—¥å¿— #${i}`);
    }
    if (i % 1000 === 0) {
      logger.error(`é”™è¯¯æ—¥å¿— #${i}`, new Error('æµ‹è¯•é”™è¯¯'));
    }
  }

  performance.mark('end');
  performance.measure('æ—¥å¿—è®°å½•æ—¶é—´', 'start', 'end');

  // æµ‹è¯•å†…å­˜æ³„æ¼
  forceGC();
  const finalMemory = getMemoryUsage();
  console.log(`æœ€ç»ˆå†…å­˜ä½¿ç”¨: ${finalMemory.toFixed(2)} MB`);
  console.log(`å†…å­˜å¢é•¿: ${(finalMemory - initialMemory).toFixed(2)} MB`);

  // æ£€æŸ¥å†…å­˜å¿«ç…§ï¼ˆå †åˆ†æï¼‰
  const snapshot = v8.getHeapSnapshot();
  // è¿™é‡Œå¯ä»¥ä¿å­˜å¿«ç…§æˆ–åˆ†æå †å¯¹è±¡
};

// è¿è¡Œæµ‹è¯•
const logger = new LogMaster();
runMemoryTest(logger, 100000);
```

### 5. CPU åˆ†æ

```javascript
// tests/performance/cpu-profile.js
import LogMaster from '../../src/LogMaster';
import { Session } from 'inspector';
import fs from 'fs';
import path from 'path';

const session = new Session();
session.connect();

// åˆ›å»ºè¾“å‡ºç›®å½•
const profileDir = path.join(__dirname, '../../profiles');
if (!fs.existsSync(profileDir)) {
  fs.mkdirSync(profileDir);
}

// å¼€å§‹CPUåˆ†æ
const startProfiling = () => {
  session.post('Profiler.enable');
  session.post('Profiler.start');
};

// ç»“æŸCPUåˆ†æå¹¶ä¿å­˜ç»“æœ
const stopProfiling = () => {
  return new Promise((resolve) => {
    session.post('Profiler.stop', (err, { profile }) => {
      if (err) {
        console.error('åˆ†æé”™è¯¯:', err);
        return resolve(null);
      }

      // ä¿å­˜åˆ†æç»“æœ
      const profileFile = path.join(profileDir, `cpu-profile-${Date.now()}.cpuprofile`);
      fs.writeFileSync(profileFile, JSON.stringify(profile));
      console.log(`CPUåˆ†æå·²ä¿å­˜åˆ° ${profileFile}`);

      session.post('Profiler.disable');
      resolve(profileFile);
    });
  });
};

// æ¨¡æ‹ŸçœŸå®åº”ç”¨åœºæ™¯çš„æµ‹è¯•
const runCpuTest = async () => {
  const logger = new LogMaster();

  // æ·»åŠ å¤šä¸ªä¼ è¾“
  logger.addTransport({
    log: () => {
      // æ¨¡æ‹Ÿä¼ è¾“å»¶è¿Ÿ
      const start = Date.now();
      while (Date.now() - start < 0.1) {} // å¿™ç­‰å¾…0.1æ¯«ç§’
    }
  });

  // å¼€å§‹åˆ†æ
  startProfiling();

  // æ¨¡æ‹Ÿåº”ç”¨ç¨‹åºå·¥ä½œè´Ÿè½½
  const iterations = 50000;
  console.log(`æ‰§è¡Œ ${iterations} æ¬¡æ—¥å¿—è®°å½•...`);

  for (let i = 0; i < iterations; i++) {
    // æ··åˆä¸åŒçº§åˆ«çš„æ—¥å¿—
    const level = i % 10;
    if (level < 7) {
      logger.debug(`è°ƒè¯•æ—¥å¿— #${i}`);
    } else if (level < 9) {
      logger.info(`ä¿¡æ¯æ—¥å¿— #${i}`, { data: i });
    } else if (level < 10) {
      logger.warn(`è­¦å‘Šæ—¥å¿— #${i}`);
    } else {
      logger.error(`é”™è¯¯æ—¥å¿— #${i}`, new Error('æµ‹è¯•é”™è¯¯'));
    }

    // æ¨¡æ‹Ÿåº”ç”¨ç¨‹åºå·¥ä½œ
    if (i % 1000 === 0) {
      await new Promise(resolve => setTimeout(resolve, 1));
    }
  }

  // ç»“æŸåˆ†æ
  const profileFile = await stopProfiling();
  console.log('æµ‹è¯•å®Œæˆ');
  return profileFile;
};

// è¿è¡Œæµ‹è¯•
runCpuTest().catch(console.error);
```

### 6. ä¸åŸç”Ÿæ§åˆ¶å°å¯¹æ¯”æµ‹è¯•

```javascript
// tests/performance/console-comparison.js
import Benchmark from 'benchmark';
import LogMaster from '../../src/LogMaster';

const suite = new Benchmark.Suite();

// ç¦ç”¨å®é™…è¾“å‡º
const originalConsole = {
  log: console.log,
  info: console.info,
  warn: console.warn,
  error: console.error
};

console.log = () => {};
console.info = () => {};
console.warn = () => {};
console.error = () => {};

const logger = new LogMaster();
const testObj = { user: 'test', id: 123, nested: { value: true } };

suite
  .add('LogMaster.info(ç®€å•å­—ç¬¦ä¸²)', () => {
    logger.info('æµ‹è¯•æ—¥å¿—');
  })
  .add('console.info(ç®€å•å­—ç¬¦ä¸²)', () => {
    console.info('æµ‹è¯•æ—¥å¿—');
  })
  .add('LogMaster.info(å¯¹è±¡)', () => {
    logger.info('æµ‹è¯•å¯¹è±¡', testObj);
  })
  .add('console.info(å¯¹è±¡)', () => {
    console.info('æµ‹è¯•å¯¹è±¡', testObj);
  })
  .add('LogMaster.error(é”™è¯¯å¯¹è±¡)', () => {
    logger.error('é”™è¯¯', new Error('æµ‹è¯•é”™è¯¯'));
  })
  .add('console.error(é”™è¯¯å¯¹è±¡)', () => {
    console.error('é”™è¯¯', new Error('æµ‹è¯•é”™è¯¯'));
  })

  .on('cycle', (event) => {
    console.log(String(event.target));
  })
  .on('complete', function() {
    console.log('Fastest is ' + this.filter('fastest').map('name'));

    // æ¢å¤æ§åˆ¶å°
    console.log = originalConsole.log;
    console.info = originalConsole.info;
    console.warn = originalConsole.warn;
    console.error = originalConsole.error;

    console.log('æµ‹è¯•å®Œæˆ');
  })

  .run({ 'async': true });
```

## å…­ã€è¦†ç›–ç‡è¦æ±‚ä¸åˆ†æ

### 1. è¦†ç›–ç‡ç›®æ ‡

LogMaster é¡¹ç›®éµå¾ªä¸¥æ ¼çš„æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡ï¼Œç¡®ä¿ä»£ç è´¨é‡å’Œå¯é æ€§ï¼š

| è¦†ç›–ç±»å‹    | æœ€ä½è¦æ±‚ | ç›®æ ‡è¦æ±‚ | è¯´æ˜                                    |
|------------|---------|---------|----------------------------------------|
| è¡Œè¦†ç›–ç‡    | 95%     | 100%    | å‡ ä¹æ‰€æœ‰ä»£ç è¡Œéƒ½åº”è¢«æµ‹è¯•æ‰§è¡Œ            |
| åˆ†æ”¯è¦†ç›–ç‡  | 90%     | 95%     | å¤§å¤šæ•°æ¡ä»¶åˆ†æ”¯éƒ½åº”è¢«æµ‹è¯•                |
| å‡½æ•°è¦†ç›–ç‡  | 95%     | 100%    | æ‰€æœ‰å…¬å…±APIéƒ½å¿…é¡»æœ‰æµ‹è¯•                 |
| è¯­å¥è¦†ç›–ç‡  | 95%     | 100%    | å‡ ä¹æ‰€æœ‰è¯­å¥éƒ½åº”è¢«æµ‹è¯•æ‰§è¡Œ              |

### 2. æ’é™¤é¡¹

æŸäº›æƒ…å†µä¸‹ï¼Œä»¥ä¸‹ç±»å‹çš„ä»£ç å¯ä»¥ä»è¦†ç›–ç‡è®¡ç®—ä¸­æ’é™¤ï¼š

- ä¸ç‰¹å®šå¹³å°ç›¸å…³çš„å…¼å®¹æ€§ä»£ç 
- çº¯ç²¹çš„ç±»å‹å®šä¹‰æ–‡ä»¶
- ç¬¬ä¸‰æ–¹åº“å°è£…
- ç‰¹å®šäºè°ƒè¯•çš„ä»£ç 

### 3. è‡ªåŠ¨è¦†ç›–ç‡æŠ¥å‘Š

é€šè¿‡ GitHub Actions è‡ªåŠ¨ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Šå¹¶å‘å¸ƒåˆ° Codecovï¼š

```yaml
# .github/workflows/coverage.yml
name: Test Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  coverage:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '16'
      - run: npm ci
      - run: npm test -- --coverage
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ./coverage/
          fail_ci_if_error: true
```

### 4. è¦†ç›–ç‡æŠ¥å‘Šè§£é‡Š

æ¯æ¬¡æäº¤åï¼Œç”Ÿæˆçš„è¦†ç›–ç‡æŠ¥å‘Šåº”è¯¥åŒ…å«ï¼š

- æ€»ä½“è¦†ç›–ç‡ç™¾åˆ†æ¯”
- æœªè¦†ç›–è¡Œçš„å…·ä½“ä½ç½®
- è¦†ç›–ç‡å˜åŒ–è¶‹åŠ¿
- æŒ‰æ–‡ä»¶çš„è¦†ç›–ç‡ç»†åˆ†

### 5. è¦†ç›–ç‡æœ€ä½è¦æ±‚æ£€æŸ¥

åœ¨ `package.json` ä¸­é…ç½®Jestä»¥å¼ºåˆ¶æ‰§è¡Œæœ€ä½è¦†ç›–ç‡è¦æ±‚ï¼š

```json
{
  "jest": {
    "coverageThreshold": {
      "global": {
        "branches": 90,
        "functions": 95,
        "lines": 95,
        "statements": 95
      }
    }
  }
}
```

### 6. è¦†ç›–ç‡å¾½ç« 

åœ¨READMEä¸­æ·»åŠ è¦†ç›–ç‡å¾½ç« ï¼Œå®æ—¶åæ˜ é¡¹ç›®çš„æµ‹è¯•è¦†ç›–ç‡çŠ¶æ€ï¼š

```markdown
[![æµ‹è¯•è¦†ç›–ç‡](https://img.shields.io/codecov/c/github/username/logmaster)](https://codecov.io/gh/username/logmaster)
```

### 7. ä¼˜å…ˆæµ‹è¯•ç­–ç•¥

ä¸ºäº†åˆç†åˆ†é…æµ‹è¯•èµ„æºï¼Œåº”ä¼˜å…ˆæµ‹è¯•ï¼š

1. æ ¸å¿ƒAPIæ–¹æ³•ï¼ˆå¦‚ `debug`, `info`, `warn`, `error`ï¼‰
2. é…ç½®ä¸åˆå§‹åŒ–é€»è¾‘
3. ä¼ è¾“ç³»ç»Ÿé›†æˆç‚¹
4. æ ¼å¼åŒ–å’Œæ ·å¼å¤„ç†
5. æµè§ˆå™¨å…¼å®¹æ€§æ£€æµ‹

## ä¸ƒã€æŒç»­é›†æˆæµ‹è¯•æµç¨‹

### 1. CI/CD ç®¡é“è®¾è®¡

LogMaster é¡¹ç›®é‡‡ç”¨å®Œæ•´çš„ CI/CD æµç¨‹ï¼Œè‡ªåŠ¨åŒ–æµ‹è¯•å’Œéƒ¨ç½²ï¼š

```mermaid
graph TD
    A[ä»£ç æäº¤] --> B[å®‰è£…ä¾èµ–]
    B --> C[Lintæ£€æŸ¥]
    C --> D[å•å…ƒæµ‹è¯•]
    D --> E[é›†æˆæµ‹è¯•]
    E --> F[è¦†ç›–ç‡æ£€æŸ¥]
    F --> G{æ˜¯PRè¿˜æ˜¯ä¸»åˆ†æ”¯?}
    G -- PR --> H[æ€§èƒ½å›å½’æµ‹è¯•]
    G -- ä¸»åˆ†æ”¯ --> I[å…¨é¢E2Eæµ‹è¯•]
    H --> J[ä»£ç å®¡æ ¸]
    I --> K[æ„å»ºå‘å¸ƒåŒ…]
    K --> L[å‘å¸ƒåˆ°NPM]
```

### 2. GitHub Actions é…ç½®

#### ä¸»è¦å·¥ä½œæµé…ç½®

```yaml
# .github/workflows/ci.yml
name: CI Workflow

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [14.x, 16.x, 18.x]

    steps:
    - uses: actions/checkout@v2

    - name: ä½¿ç”¨ Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v2
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: å®‰è£…ä¾èµ–
      run: npm ci

    - name: è¿è¡Œ Lint
      run: npm run lint

    - name: è¿è¡Œå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
      run: npm test

    - name: æ£€æŸ¥è¦†ç›–ç‡
      run: npm run test:coverage

  e2e:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v2

    - name: ä½¿ç”¨ Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '16'
        cache: 'npm'

    - name: å®‰è£…ä¾èµ–
      run: npm ci

    - name: å®‰è£… Playwright
      run: npx playwright install --with-deps

    - name: è¿è¡Œ E2E æµ‹è¯•
      run: npm run test:e2e

    - name: ä¸Šä¼  Playwright ç»“æœ
      if: always()
      uses: actions/upload-artifact@v2
      with:
        name: playwright-results
        path: test-results/

  performance:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - uses: actions/checkout@v2

    - name: ä½¿ç”¨ Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '16'
        cache: 'npm'

    - name: å®‰è£…ä¾èµ–
      run: npm ci

    - name: è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
      run: npm run test:perf

    - name: æ£€æŸ¥æ€§èƒ½å›å½’
      run: node scripts/check-perf-regression.js
```

#### å‘å¸ƒå·¥ä½œæµ

```yaml
# .github/workflows/release.yml
name: Release

on:
  release:
    types: [created]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '16'
          registry-url: 'https://registry.npmjs.org/'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: æµ‹è¯•
        run: npm test

      - name: æ„å»º
        run: npm run build

      - name: å‘å¸ƒåˆ° NPM
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{secrets.NPM_TOKEN}}
```

### 3. è‡ªåŠ¨æµ‹è¯•è§¦å‘ç­–ç•¥

| äº‹ä»¶               | è§¦å‘çš„æµ‹è¯•ç±»å‹                               | å·¥ä½œæµ                         |
|-------------------|-------------------------------------------|------------------------------|
| æ¯æ¬¡æäº¤           | Lintã€å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•                     | CI Workflow                  |
| Pull Request      | ä¸Šè¿° + è¦†ç›–ç‡ã€æ€§èƒ½æµ‹è¯•                      | CI Workflow                  |
| åˆå¹¶åˆ°ä¸»åˆ†æ”¯       | ä¸Šè¿° + E2E æµ‹è¯•                             | CI Workflow                  |
| æ¯å‘¨è°ƒåº¦           | å…¨å¥—æµ‹è¯• + æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•                  | Weekly Tests                 |
| åˆ›å»ºå‘å¸ƒæ ‡ç­¾        | å…¨å¥—æµ‹è¯• + æ„å»ºå‘å¸ƒåŒ…                       | Release                      |

### 4. æµ‹è¯•ç¯å¢ƒç®¡ç†

- **å¼€å‘ç¯å¢ƒ**ï¼šæœ¬åœ°å¼€å‘å’Œ PR éªŒè¯
- **æµ‹è¯•ç¯å¢ƒ**ï¼šç”¨äºé›†æˆæµ‹è¯•çš„ä¸“ç”¨ç¯å¢ƒ
- **æš‚å­˜ç¯å¢ƒ**ï¼šå‘å¸ƒå‰éªŒè¯çš„å‡†ç”Ÿäº§ç¯å¢ƒ
- **ç”Ÿäº§ç¯å¢ƒ**ï¼šNPM å’Œ CDN å‘å¸ƒ

### 5. æµ‹è¯•æŠ¥å‘Šä¸é€šçŸ¥

æ„å»ºå’Œæµ‹è¯•ç»“æœå°†é€šè¿‡ä»¥ä¸‹æ–¹å¼é€šçŸ¥å¼€å‘å›¢é˜Ÿï¼š

- GitHub Checks UI ç›´æ¥æ˜¾ç¤ºæµ‹è¯•çŠ¶æ€
- Pull Request è¯„è®ºè‡ªåŠ¨åŒ…å«æµ‹è¯•ç»“æœ
- å¤±è´¥æµ‹è¯•çš„ç”µå­é‚®ä»¶é€šçŸ¥
- Slack å·¥ä½œåŒºé€šçŸ¥å…³é”®äº‹ä»¶

### 6. æ€§èƒ½å›å½’æ£€æµ‹

è‡ªåŠ¨æ£€æµ‹æ€§èƒ½å›å½’çš„è„šæœ¬ï¼š

```javascript
// scripts/check-perf-regression.js
const fs = require('fs');
const path = require('path');

// åŠ è½½æœ€æ–°æ€§èƒ½æµ‹è¯•ç»“æœ
const latestResults = require('../test-results/perf-latest.json');

// åŠ è½½åŸºå‡†æ€§èƒ½ç»“æœ
const baselinePath = path.join(__dirname, '../test-results/perf-baseline.json');
let baselineResults;

try {
  baselineResults = require(baselinePath);
} catch (e) {
  console.log('æ²¡æœ‰æ‰¾åˆ°åŸºå‡†æ€§èƒ½æµ‹è¯•ç»“æœï¼Œå°†å½“å‰ç»“æœè®¾ä¸ºåŸºå‡†');
  fs.copyFileSync(
    path.join(__dirname, '../test-results/perf-latest.json'),
    baselinePath
  );
  process.exit(0);
}

// æ¯”è¾ƒæ€§èƒ½ç»“æœ
const regressions = [];
const improvements = [];

Object.keys(latestResults).forEach(testName => {
  const baseline = baselineResults[testName] || { ops: 0 };
  const latest = latestResults[testName];

  // è®¡ç®—æ€§èƒ½å˜åŒ–ç™¾åˆ†æ¯”
  const changePercent = ((latest.ops - baseline.ops) / baseline.ops) * 100;

  if (changePercent < -5) {
    // è¶…è¿‡5%çš„æ€§èƒ½ä¸‹é™è§†ä¸ºå›å½’
    regressions.push({
      test: testName,
      baseline: baseline.ops,
      current: latest.ops,
      change: changePercent.toFixed(2) + '%'
    });
  } else if (changePercent > 5) {
    // è¶…è¿‡5%çš„æ€§èƒ½æå‡è®°å½•ä¸‹æ¥
    improvements.push({
      test: testName,
      baseline: baseline.ops,
      current: latest.ops,
      change: '+' + changePercent.toFixed(2) + '%'
    });
  }
});

// è¾“å‡ºç»“æœ
console.log('\n====== æ€§èƒ½æµ‹è¯•ç»“æœ ======\n');

if (regressions.length > 0) {
  console.log('âš ï¸ æ£€æµ‹åˆ°æ€§èƒ½å›å½’:');
  console.table(regressions);

  if (regressions.some(r => parseFloat(r.change) < -10)) {
    console.error('âŒ ä¸¥é‡æ€§èƒ½å›å½’! éƒ¨åˆ†æµ‹è¯•æ€§èƒ½ä¸‹é™è¶…è¿‡10%');
    process.exit(1);
  }
} else {
  console.log('âœ… æ²¡æœ‰æ£€æµ‹åˆ°æ€§èƒ½å›å½’');
}

if (improvements.length > 0) {
  console.log('\nğŸ‰ æ€§èƒ½æ”¹è¿›:');
  console.table(improvements);
}

// å¦‚æœæ²¡æœ‰ä¸¥é‡å›å½’ï¼Œæ›´æ–°åŸºå‡†
if (process.env.UPDATE_BASELINE === 'true') {
  fs.copyFileSync(
    path.join(__dirname, '../test-results/perf-latest.json'),
    baselinePath
  );
  console.log('\nâœ… å·²æ›´æ–°æ€§èƒ½åŸºå‡†');
}
```

## å…«ã€æµ‹è¯•æœ€ä½³å®è·µ

### 1. æµ‹è¯•æ–‡ä»¶ç»„ç»‡

æ¯ä¸ªæµ‹è¯•æ–‡ä»¶åº”å…·æœ‰æ¸…æ™°çš„ç»“æ„ï¼š

```javascript
// 1. å¯¼å…¥è¯­å¥
import { ... } from '...';

// 2. æµ‹è¯•å¥—ä»¶æè¿° - æè¿°è¢«æµ‹å•å…ƒ
describe('è¢«æµ‹æ¨¡å—åç§°', () => {
  // 3. å›ºå®šè£…ç½®è®¾ç½®
  let testObject;

  beforeEach(() => {
    // è®¾ç½®æµ‹è¯•ç¯å¢ƒ
  });

  afterEach(() => {
    // æ¸…ç†æµ‹è¯•ç¯å¢ƒ
  });

  // 4. åˆ†ç»„æµ‹è¯•ç”¨ä¾‹
  describe('ç‰¹å®šåŠŸèƒ½', () => {
    // 5. å•ä¸€æµ‹è¯•ç”¨ä¾‹ - éµå¾ªAAAæ¨¡å¼
    test('åº”è¯¥æ­£ç¡®å¤„ç†XXæƒ…å†µ', () => {
      // Arrange - å‡†å¤‡æµ‹è¯•æ•°æ®å’Œç¯å¢ƒ
      const input = ...;

      // Act - æ‰§è¡Œè¢«æµ‹æ“ä½œ
      const result = testObject.method(input);

      // Assert - éªŒè¯ç»“æœ
      expect(result).toBe(expected);
    });

    // æ›´å¤šæµ‹è¯•...
  });

  // æ›´å¤šåŠŸèƒ½åˆ†ç»„...
});
```

### 2. æµ‹è¯•æè¿°è§„èŒƒ

æµ‹è¯•ç”¨ä¾‹çš„æè¿°åº”éµå¾ªä¸€è‡´çš„æ¨¡å¼ï¼Œæ¸…æ™°è¡¨è¾¾:

- **æµ‹è¯•å¥—ä»¶**: `describe('ComponentName', ...)`
- **åŠŸèƒ½åˆ†ç»„**: `describe('methodName', ...)`
- **æµ‹è¯•ç”¨ä¾‹**: `test('should do X when Y', ...)`

æ¨èçš„æ¨¡å¼æ˜¯ "åº”è¯¥ [é¢„æœŸè¡Œä¸º] å½“ [æ¡ä»¶]"ï¼Œä¾‹å¦‚:

```javascript
test('åº”è¯¥è¿‡æ»¤DEBUGçº§åˆ«æ—¥å¿—å½“æ—¥å¿—çº§åˆ«è®¾ä¸ºINFO', () => {
  // æµ‹è¯•å®ç°
});
```

### 3. æµ‹è¯•æ•°æ®ç®¡ç†

#### 3.1 æµ‹è¯•å¤¹å…·æ–‡ä»¶

å¯¹äºå¤æ‚çš„æµ‹è¯•æ•°æ®ï¼Œä½¿ç”¨ä¸“é—¨çš„å¤¹å…·æ–‡ä»¶:

```javascript
// tests/fixtures/log-data.js
export const sampleLogs = [
  { level: 'DEBUG', message: 'è°ƒè¯•æ¶ˆæ¯', timestamp: '10:00:00' },
  { level: 'INFO', message: 'ä¿¡æ¯æ¶ˆæ¯', timestamp: '10:01:00' },
  // æ›´å¤šç¤ºä¾‹...
];

export const sampleErrors = [
  new Error('ç¤ºä¾‹é”™è¯¯1'),
  { name: 'CustomError', message: 'è‡ªå®šä¹‰é”™è¯¯ç¤ºä¾‹' }
];
```

#### 3.2 å·¥å‚å‡½æ•°

ä½¿ç”¨å·¥å‚å‡½æ•°ç”Ÿæˆæµ‹è¯•æ•°æ®:

```javascript
// tests/factories/log-factory.js
export function createLogEntry(overrides = {}) {
  return {
    level: 'INFO',
    message: 'é»˜è®¤æ¶ˆæ¯',
    timestamp: new Date().toISOString(),
    ...overrides
  };
}
```

### 4. æ¨¡æ‹Ÿä¸æ¡©çš„æœ€ä½³å®è·µ

#### 4.1 åˆç†ä½¿ç”¨æ¨¡æ‹Ÿ

- åªæ¨¡æ‹Ÿç›´æ¥ä¾èµ–ï¼Œé¿å…è¿‡åº¦æ¨¡æ‹Ÿ
- å°½é‡ä½¿ç”¨çœŸå®å®ç°ï¼Œä»…åœ¨å¿…è¦æ—¶æ¨¡æ‹Ÿ
- éªŒè¯æ¨¡æ‹Ÿè°ƒç”¨ï¼Œä½†ä¸è¦è¿‡åº¦æŒ‡å®šå®ç°ç»†èŠ‚

```javascript
// æ¨èå†™æ³•
jest.spyOn(console, 'log').mockImplementation();
expect(console.log).toHaveBeenCalledWith(
  expect.stringContaining('æ¶ˆæ¯'),
  expect.any(Object)
);

// é¿å…è¿‡åº¦æŒ‡å®š
expect(console.log).toHaveBeenCalledWith(
  '%c[10:00:00] %câœ… ç²¾ç¡®æ¶ˆæ¯',  // è¿‡äºè„†å¼±
  'color: #888',
  'color: #00aa00; font-weight: bold'
);
```

#### 4.2 ä½¿ç”¨é€‚å½“çº§åˆ«çš„æ¨¡æ‹Ÿ

- **è½»é‡çº§æ¨¡æ‹Ÿ**: å¯¹äºç®€å•æ›¿æ¢çš„å‡½æ•°
- **ä¸­ç­‰æ¨¡æ‹Ÿ**: ç›‘è§†ç°æœ‰æ–¹æ³•çš„è°ƒç”¨
- **æ·±åº¦æ¨¡æ‹Ÿ**: å®Œå…¨æ›¿ä»£å¹¶æ¨¡æ‹Ÿå†…éƒ¨è¡Œä¸º

```javascript
// è½»é‡çº§æ¨¡æ‹Ÿ
const mockFn = jest.fn();

// ä¸­ç­‰æ¨¡æ‹Ÿ
jest.spyOn(object, 'method').mockImplementation(() => 'result');

// æ·±åº¦æ¨¡æ‹Ÿ
jest.mock('module-name', () => ({
  Method: jest.fn().mockImplementation(() => ({
    property: 'value',
    action: jest.fn()
  }))
}));
```

### 5. å¼‚æ­¥æµ‹è¯•å¤„ç†

#### 5.1 Promises

```javascript
test('å¼‚æ­¥ä¼ è¾“åº”æ­£ç¡®å¤„ç†æ—¥å¿—', async () => {
  // è®¾ç½®
  const mockTransport = {
    log: jest.fn().mockResolvedValue(true)
  };

  logger.addTransport(mockTransport);

  // æ‰§è¡Œ
  logger.info('æµ‹è¯•æ¶ˆæ¯');

  // ç­‰å¾…å¼‚æ­¥é˜Ÿåˆ—æ¸…ç©º
  await new Promise(r => setTimeout(r, 0));

  // éªŒè¯
  expect(mockTransport.log).toHaveBeenCalled();
});
```

#### 5.2 Async/Await

```javascript
test('ç­‰å¾…æ—¥å¿—åˆ·æ–°', async () => {
  const mockTransport = {
    flush: jest.fn().mockResolvedValue(true)
  };

  logger.addTransport(mockTransport);
  logger.info('æµ‹è¯•æ¶ˆæ¯');

  await logger.flush();

  expect(mockTransport.flush).toHaveBeenCalled();
});
```

### 6. å¿«ç…§æµ‹è¯•ä½¿ç”¨å‡†åˆ™

- å¯¹äºç¨³å®šä½†å¤æ‚çš„è¾“å‡ºç»“æ„ä½¿ç”¨å¿«ç…§æµ‹è¯•
- ä¿æŒå¿«ç…§å°ä¸”èšç„¦ï¼Œé¿å…è¿‡å¤§çš„å¿«ç…§
- è°¨æ…æ£€æŸ¥å¿«ç…§æ›´æ–°ï¼Œä¸è¦ç›²ç›®æ¥å—å˜åŒ–

```javascript
test('æ ¼å¼åŒ–æ—¥å¿—åº”ä¿æŒä¸€è‡´æ ¼å¼', () => {
  // å›ºå®šæ—¥æœŸä»¥ç¡®ä¿ä¸€è‡´æ€§
  jest.spyOn(Date.prototype, 'toLocaleTimeString')
      .mockReturnValue('12:34:56');

  const result = formatter.format('INFO', ['æµ‹è¯•æ¶ˆæ¯']);
  expect(result).toMatchSnapshot();
});
```

### 7. ä»£ç è¦†ç›–ç‡å¢å¼ºæŠ€å·§

- **åˆ†æ”¯è¦†ç›–**: ä½¿ç”¨å‚æ•°åŒ–æµ‹è¯•è¦†ç›–å¤šä¸ªæ¡ä»¶åˆ†æ”¯
- **å‡½æ•°è¦†ç›–**: ç¡®ä¿æ‰€æœ‰å¯¼å‡ºçš„å…¬å…±APIéƒ½æœ‰æµ‹è¯•
- **è¡Œè¦†ç›–**: é¿å…æ— æ³•åˆ°è¾¾çš„ä»£ç æˆ–æœªæµ‹è¯•çš„è¾¹ç•Œæƒ…å†µ
- **è·¯å¾„è¦†ç›–**: åœ¨å¤æ‚å‡½æ•°ä¸­æµ‹è¯•å¤šç§æ‰§è¡Œè·¯å¾„

```javascript
// å‚æ•°åŒ–æµ‹è¯•ç¤ºä¾‹
const testCases = [
  { level: 'DEBUG', visible: true, expected: true },
  { level: 'INFO', visible: true, expected: true },
  { level: 'DEBUG', visible: false, expected: false },
  // æ›´å¤šæµ‹è¯•ç”¨ä¾‹...
];

test.each(testCases)(
  'æ—¥å¿—å¯è§æ€§: %pçº§åˆ«, å¯è§æ€§=%p, æœŸæœ›=%p',
  ({ level, visible, expected }) => {
    logger.setLogLevel(visible ? 'DEBUG' : 'INFO');
    const result = logger.isLevelVisible(level);
    expect(result).toBe(expected);
  }
);
```

### 8. æµ‹è¯•è°ƒè¯•æŠ€å·§

- ä½¿ç”¨ `console.log` ä¸ `--testNamePattern` è°ƒè¯•ç‰¹å®šæµ‹è¯•
- éš”ç¦»å¤±è´¥æµ‹è¯•å¹¶ä½¿ç”¨ `.only` èšç„¦
- ä½¿ç”¨ Jest çš„ `--verbose` æ ‡å¿—è¾“å‡ºæ›´å¤šç»†èŠ‚

```bash
# è°ƒè¯•ç‰¹å®šæµ‹è¯•
npm test -- --testNamePattern="åº”æ­£ç¡®å¤„ç†é”™è¯¯æ—¥å¿—"

# ä½¿ç”¨è¯¦ç»†è¾“å‡º
npm test -- --verbose

# è°ƒè¯•æ¨¡å¼
node --inspect-brk ./node_modules/jest/bin/jest.js --runInBand
```

é€šè¿‡éµå¾ªè¿™äº›æœ€ä½³å®è·µï¼ŒLogMaster é¡¹ç›®å¯ä»¥ä¿æŒé«˜è´¨é‡çš„æµ‹è¯•è¦†ç›–å¹¶ç¡®ä¿å¯é æ€§ã€‚
